# 'main' required ci, does a distcheck (builds, tests, check install)
# image created off dockerfile in repo, compile/link flags are set there
name: Build libFMS test with autotools

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        conf-flag: [--disable-openmp, --enable-mixed-mode, --with-mpi=no]
        input-flag:  [--with-yaml, --enable-test-input=/home/unit_tests_input]
        io-flag: [ --enable-deprecated-io, --disable-deprecated-io]
        exclude:
          - conf-flag: --with-mpi=no
            input-flag: --enable-test-input=/home/unit_tests_input
    container:
      image: ryanmulhall/fms-ci-rocky-gnu:12.2.0
      env:
        TEST_VERBOSE: 1
        DISTCHECK_CONFIGURE_FLAGS: "${{ matrix.conf-flag }} ${{ matrix.input-flag }} ${{ matrix.io-flag }}"
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Prepare GNU autoconf for build
      run: autoreconf -if
    - name: Configure the build
      run: ./configure ${DISTCHECK_CONFIGURE_FLAGS}
    - name: Build the library
      run: make distcheck
      if: ${{ matrix.conf-flag != '--with-mpi=no' }}
    - name: Build the library (without test suite for serial build)
      run: make
      if: ${{ matrix.conf-flag == '--with-mpi=no' }}
