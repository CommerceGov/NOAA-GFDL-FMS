name: Build libFMS test with autotools

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distcheck-conf-flags: [--enable-openmp, --disable-openmp, --enable-mixed-mode, --disable-setting-flags ]
        yaml-flag: [ --with-yaml, "" ]
    container:
      image: noaagfdl/ubuntu_libfms_gnu
      env:
        FCFLAGS: "-I/usr/include"
        VERBOSE: 1
        DISTCHECK_CONFIGURE_FLAGS: "${{ matrix.distcheck-conf-flags }} ${{ matrix.yaml-flag }}"
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Prepare GNU autoconf for build
      run: autoreconf -if
    - name: Configure the build
      if: ${{ matrix.distcheck-conf-flags != '--disable-setting-flags' }}
      run: ./configure ${DISTCHECK_CONFIGURE_FLAGS}
    - name: Configure the build with compiler flags
      if: ${{ matrix.distcheck-conf-flags == '--disable-setting-flags' }}
      run: ./configure ${DISTCHECK_CONFIGURE_FLAGS}
      env:
        FCFLAGS: "-fdefault-real-8 -fdefault-double-8 -fcray-pointer -ffree-line-length-none -I/usr/include"
    - name: Build the library
      run: make -j distcheck
  # triggers the coupler's CI to check it still compiles successfully with FMS
  # only runs on updates to main
  trigger-coupler-ci:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
    - name: Send webhook
      if: github.repository == 'rem1776/FMS' && github.ref == 'refs/heads/coupler-webhook'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.PAT_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: 'rem1776',
            repo: 'FMScoupler',
            workflow_id: 'build.yml',
            ref: 'refs/heads/coupler-webhook'
          })
