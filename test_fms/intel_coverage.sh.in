#!/usr/bin/sh
# Produces a code coverage report for each subdirectory using intel's codecov tool

aggregate_dpis () {

  mkdir coverage-data

  for dir in `find . -maxdepth 1 -mindepth 1 -type d -printf '%f\n'`
  do
    cd $dir
    if [ ! -z "`find . -type f -name "*.dyn" `" ]; then
      profmerge -prof_dpi ${dir}.dpi
      mv ${dir}.dpi ../coverage-data
      echo ${dir} done.
    fi
    cd ..
  done

  cd coverage-data
  profmerge -a -prof_dpi ${1}.dpi *
  cd ..
}

# combine runtime generated coverage data from src and tests
aggregate_dpis src
cd test_fms
aggregate_dpis tests
cd ..
cp coverage-data/src.dpi ./
cp test_fms/coverage-data/tests.dpi ./
profmerge -a -prof_dpi fms-global-coverage.dpi src.dpi tests.dpi

# generate code coverage report for each (src) subdirectory
mkdir coverage-report
for dir in `find . -maxdepth 1 -mindepth 1 -type d -printf '%f\n'`
do
  cd $dir
  if [ ! -z "`find . -type f -name "*.spi"`" ]; then
    mkdir ../coverage-report/$dir
    codecov -prj $dir -spi pgopti.spi -dpi ../fms-global-coverage.dpi
    cp CODE_COVERAGE.HTML ../coverage-report/$dir
    cp -r CodeCoverage ../coverage-report/$dir
  fi
  cd ..
done


